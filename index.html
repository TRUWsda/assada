<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRUWPi - تسجيل الدخول</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Custom styles for background and font */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a2e; /* Dark purple/blue background */
            color: #e0e0e0; /* Light grey text */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden; /* Hide overflow for background elements */
            position: relative;
        }

        /* Custom button styles */
        .btn-primary {
            background: linear-gradient(135deg, #8a2be2, #4b0082); /* Purple gradient */
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        .btn-primary:disabled {
            background: #4a4a5a; /* Darker grey for disabled */
            cursor: not-allowed;
            box-shadow: none;
        }
        .btn-secondary {
            background-color: #33334d; /* Darker grey */
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .btn-secondary:hover {
            background-color: #444466;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        .input-field {
            background-color: #33334d;
            border: 1px solid #555577;
            color: #e0e0e0;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            outline: none;
            transition: border-color 0.3s ease;
        }
        .input-field:focus {
            border-color: #8a2be2;
        }

        /* Login/Signup Modal Styles */
        #loginSignupModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        #loginSignupModalContent {
            background-color: #22223b;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        #loginSignupError {
            color: #fca5a5;
            font-size: 0.85rem;
            margin-top: 0.5rem;
            min-height: 1.2rem; /* Reserve space to prevent layout shift */
        }
        .form-toggle-buttons {
            display: flex;
            justify-content: center;
            margin-bottom: 1.5rem;
            gap: 1rem;
        }
        .form-toggle-buttons button {
            padding: 0.5rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: bold;
            transition: all 0.2s ease;
        }
        .form-toggle-buttons button.active {
            background-color: #8a2be2;
            color: white;
        }
        .form-toggle-buttons button:not(.active) {
            background-color: #33334d;
            color: #b0b0b0;
        }
    </style>
</head>
<body dir="rtl">
    <div id="loginSignupModal">
        <div id="loginSignupModalContent">
            <div class="form-toggle-buttons">
                <button id="showLoginBtn" class="active" data-form="login">تسجيل الدخول</button>
                <button id="showSignupBtn" data-form="signup">إنشاء حساب</button>
            </div>

            <div id="loginForm">
                <h3 class="text-xl font-bold mb-4" id="loginTitle">تسجيل الدخول</h3>
                <input type="email" id="loginEmail" class="input-field w-full mb-3" placeholder="البريد الإلكتروني">
                <input type="password" id="loginPassword" class="input-field w-full mb-3" placeholder="كلمة المرور">
                <p id="loginSignupError" class="text-red-400 text-sm mb-4"></p>
                <button id="loginBtn" class="btn-primary py-2 px-6 rounded-md w-full" disabled>تسجيل الدخول</button>
            </div>

            <div id="signupForm" class="hidden">
                <h3 class="text-xl font-bold mb-4" id="signupTitle">إنشاء حساب</h3>
                <input type="text" id="signupUsername" class="input-field w-full mb-3" placeholder="اسم المستخدم">
                <input type="email" id="signupEmail" class="input-field w-full mb-3" placeholder="البريد الإلكتروني">
                <input type="password" id="signupPassword" class="input-field w-full mb-3" placeholder="كلمة المرور">
                <p id="signupError" class="text-red-400 text-sm mb-4"></p>
                <button id="signupBtn" class="btn-primary py-2 px-6 rounded-md w-full" disabled>إنشاء حساب</button>
            </div>

            <div class="mt-6">
                <button id="googleSignInBtn" class="btn-secondary py-2 px-6 rounded-md w-full flex items-center justify-center gap-2" disabled>
                    <i class="fab fa-google"></i> <span id="googleSignInText">تسجيل الدخول باستخدام جوجل</span>
                </button>
            </div>
        </div>
    </div>

    <div id="lobbyPage" class="hidden"></div>
    <div id="gamePage" class="hidden"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, where, addDoc, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase variables
        let app;
        let db;
        let auth;
        let currentUserId = null;
        let currentUsername = null;

        // Global app ID from environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'game-1-b46e1';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Translation dictionary (simplified for this context)
        const translations = {
            en: {
                login: "Login",
                signup: "Sign Up",
                email: "Email",
                password: "Password",
                username: "Username",
                loginError: "Login failed. Please check your email and password.",
                signupError: "Sign up failed. Please try again with a different email.",
                invalidEmail: "Invalid email address.",
                passwordTooShort: "Password must be at least 6 characters long.",
                googleSignIn: "Sign in with Google",
                usernameRequired: "Username is required.",
                usernameInvalid: "Username must be lowercase, alphanumeric with underscores, and between 3-15 characters.",
                usernameTaken: "This username is already taken. Please choose another.",
                usernameSaved: (username) => `Username "${username}" saved successfully!`,
                authenticationSystemNotReady: "Authentication system not ready. Please try again."
            },
            ar: {
                login: "تسجيل الدخول",
                signup: "إنشاء حساب",
                email: "البريد الإلكتروني",
                password: "كلمة المرور",
                username: "اسم المستخدم",
                loginError: "فشل تسجيل الدخول. الرجاء التحقق من البريد الإلكتروني وكلمة المرور.",
                signupError: "فشل إنشاء الحساب. الرجاء المحاولة مرة أخرى ببريد إلكتروني مختلف.",
                invalidEmail: "عنوان بريد إلكتروني غير صالح.",
                passwordTooShort: "يجب أن تتكون كلمة المرور من 6 أحرف على الأقل.",
                googleSignIn: "تسجيل الدخول باستخدام جوجل",
                usernameRequired: "اسم المستخدم مطلوب.",
                usernameInvalid: "يجب أن يكون اسم المستخدم أحرفًا صغيرة وأرقامًا وشرطات سفلية، ويتراوح طوله بين 3-15 حرفًا.",
                usernameTaken: "اسم المستخدم هذا مستخدم بالفعل. الرجاء اختيار اسم آخر.",
                usernameSaved: (username) => `تم حفظ اسم المستخدم "${username}" بنجاح!`,
                authenticationSystemNotReady: "نظام المصادقة غير جاهز. الرجاء المحاولة مرة أخرى."
            }
        };

        let currentLanguage = 'ar'; // Default to Arabic for this specific request

        function getTranslation(key, ...args) {
            const translation = translations[currentLanguage][key];
            if (typeof translation === 'function') {
                return translation(...args);
            }
            return translation || key; // Fallback to key if not found
        }

        // Custom alert function (replaces window.alert)
        function alert(message) {
            const existingAlert = document.getElementById('custom-alert');
            if (existingAlert) {
                existingAlert.remove();
            }

            const alertDiv = document.createElement('div');
            alertDiv.id = 'custom-alert';
            alertDiv.className = 'fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-gray-800 text-white py-10 px-3 rounded-lg shadow-lg z-50 flex flex-col items-center';
            alertDiv.style.minWidth = '250px';

            const messageP = document.createElement('p');
            messageP.textContent = message;
            messageP.className = 'text-xl mb-4 text-center';
            alertDiv.appendChild(messageP);

            const closeButton = document.createElement('button');
            closeButton.textContent = 'OK';
            closeButton.className = 'bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500';
            closeButton.onclick = () => alertDiv.remove();
            alertDiv.appendChild(closeButton);

            document.body.appendChild(alertDiv);
        }

        // --- Firebase Integration ---
        async function setupFirebase() {
            console.log("[Firebase] Initializing Firebase...");
            try {
                if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
                    console.error("[Firebase] firebaseConfig is missing or empty. Please ensure __firebase_config is provided.");
                    alert("Firebase configuration is missing. The app cannot connect to the database.");
                    return;
                }
                console.log("[Firebase] firebaseConfig:", firebaseConfig);
                console.log("[Firebase] Using appId:", appId);
                console.log("[Firebase] initialAuthToken:", initialAuthToken);

                app = initializeApp(firebaseConfig);
                console.log("[Firebase] Firebase app initialized:", app);
                db = getFirestore(app);
                auth = getAuth(app);
                console.log("[Firebase] Firebase db and auth initialized.");

                let authReady = false; // Flag to ensure buttons are enabled only once initially

                onAuthStateChanged(auth, async (user) => {
                    if (!authReady) {
                        document.getElementById('loginBtn').disabled = false;
                        document.getElementById('signupBtn').disabled = false;
                        document.getElementById('googleSignInBtn').disabled = false;
                        console.log("[Firebase] Login/Signup buttons enabled after initial auth state check.");
                        authReady = true; // Set flag so it doesn't re-enable on subsequent state changes
                    }

                    if (user) {
                        currentUserId = user.uid;
                        console.log(`[Firebase] User authenticated: ${currentUserId}`);
                        await checkUserProfile();
                    } else {
                        currentUserId = null;
                        currentUsername = null;
                        console.log("[Firebase] User logged out or not authenticated. Showing login/signup modal.");
                        document.getElementById('loginSignupModal').classList.remove('hidden');
                    }
                });

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("[Firebase] Signed in with custom token.");
                } else {
                    console.log("[Firebase] No custom token. Awaiting user authentication via login/signup.");
                    // Ensure the modal is visible if no auto-login happens
                    // The modal is handled by onAuthStateChanged if no user is found
                }

            } catch (error) {
                console.error("Error setting up Firebase:", error);
                alert(`Failed to connect to Firebase: ${error.message}. Check your Firebase project setup.`);
            }
        }

        // --- Authentication Functions ---
        async function handleSignUp() {
            // Check auth/db here as a fallback, though buttons should be disabled if not ready
            if (!auth || !db) {
                console.error("[Auth] Firebase Auth or DB not initialized. Cannot sign up. (Fallback check)");
                document.getElementById('signupError').textContent = getTranslation('authenticationSystemNotReady');
                return;
            }

            const usernameInput = document.getElementById('signupUsername');
            const emailInput = document.getElementById('signupEmail');
            const passwordInput = document.getElementById('signupPassword');
            const errorDisplay = document.getElementById('signupError');

            const username = usernameInput.value.trim();
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();

            errorDisplay.textContent = '';

            if (!username) {
                errorDisplay.textContent = getTranslation('usernameRequired');
                return;
            }
            const usernameRegex = /^[a-z0-9_]{3,15}$/;
            if (!usernameRegex.test(username)) {
                errorDisplay.textContent = getTranslation('usernameInvalid');
                return;
            }

            if (!email || !password) {
                errorDisplay.textContent = "الرجاء إدخال البريد الإلكتروني وكلمة المرور."; // Hardcoded for simplicity in this minimal example
                return;
            }
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                errorDisplay.textContent = getTranslation('invalidEmail');
                return;
            }
            if (password.length < 6) {
                errorDisplay.textContent = getTranslation('passwordTooShort');
                return;
            }

            try {
                const usersCollectionRef = collection(db, `artifacts/${appId}/users`);
                const q = query(usersCollectionRef, where("profile.data.username", "==", username));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    errorDisplay.textContent = getTranslation('usernameTaken');
                    return;
                }

                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                currentUserId = user.uid;

                const userDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
                await setDoc(userDocRef, { username: username, language: currentLanguage }, { merge: true });
                currentUsername = username;
                alert(getTranslation('usernameSaved', username));

                console.log("[Auth] User signed up and profile created:", user.uid);
                document.getElementById('loginSignupModal').classList.add('hidden');
            } catch (error) {
                console.error("Signup error:", error);
                errorDisplay.textContent = getTranslation('signupError');
            }
        }

        async function handleLogin() {
            // Check auth/db here as a fallback
            if (!auth || !db) {
                console.error("[Auth] Firebase Auth or DB not initialized. Cannot log in. (Fallback check)");
                document.getElementById('loginSignupError').textContent = getTranslation('authenticationSystemNotReady');
                return;
            }

            const emailInput = document.getElementById('loginEmail');
            const passwordInput = document.getElementById('loginPassword');
            const errorDisplay = document.getElementById('loginSignupError');
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();

            errorDisplay.textContent = '';

            if (!email || !password) {
                errorDisplay.textContent = "الرجاء إدخال البريد الإلكتروني وكلمة المرور."; // Hardcoded for simplicity
                return;
            }

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                console.log("[Auth] User logged in:", userCredential.user.uid);
                document.getElementById('loginSignupModal').classList.add('hidden');
            } catch (error) {
                console.error("Login error:", error);
                errorDisplay.textContent = getTranslation('loginError');
            }
        }

        async function signInWithGoogle() {
            // Check auth/db here as a fallback
            if (!auth || !db) {
                console.error("[Auth] Firebase Auth or DB not initialized. Cannot sign in with Google. (Fallback check)");
                const errorDisplay = document.getElementById('loginSignupError');
                errorDisplay.textContent = getTranslation('authenticationSystemNotReady');
                return;
            }

            const provider = new GoogleAuthProvider();
            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                currentUserId = user.uid;

                console.log("[Auth] Signed in with Google:", user.uid);
                await checkUserProfile();
            } catch (error) {
                console.error("Google Sign-In error:", error);
                const errorDisplay = document.getElementById('loginSignupError');
                errorDisplay.textContent = `${getTranslation('googleSignIn')} فشل: ${error.message}`;
            }
        }

        // --- User Profile Management ---
        async function checkUserProfile() {
            if (!currentUserId || !db) {
                console.warn("[Profile] Firebase DB not ready or user not authenticated. Cannot check user profile.");
                return;
            }

            const userDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
            try {
                const userDocSnap = await getDoc(userDocRef);
                if (userDocSnap.exists() && userDocSnap.data().username) {
                    currentUsername = userDocSnap.data().username;
                    currentLanguage = userDocSnap.data().language || 'ar'; // Default to Arabic
                    document.body.dir = (currentLanguage === 'ar') ? 'rtl' : 'ltr';
                    console.log(`[Profile] User profile found. Username: ${currentUsername}, Language: ${currentLanguage}.`);
                    document.getElementById('loginSignupModal').classList.add('hidden');
                    alert(`مرحباً بك، ${currentUsername}!`); // Welcome message
                } else {
                    console.log("[Profile] User profile not found or username not set. Redirecting to signup form to set username.");
                    document.getElementById('loginSignupModal').classList.remove('hidden');
                    document.getElementById('loginForm').classList.add('hidden');
                    document.getElementById('signupForm').classList.remove('hidden');
                    document.getElementById('showLoginBtn').classList.remove('active');
                    document.getElementById('showSignupBtn').classList.add('active');
                    document.getElementById('loginSignupError').textContent = '';
                    document.getElementById('signupError').textContent = '';
                }
            } catch (error) {
                console.error("Error fetching user profile:", error);
                document.getElementById('loginSignupModal').classList.remove('hidden');
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('signupForm').classList.remove('hidden');
                document.getElementById('showLoginBtn').classList.remove('active');
                document.getElementById('showSignupBtn').classList.add('active');
                document.getElementById('loginSignupError').textContent = `${getTranslation('loginError')}: ${error.message}`;
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            console.log("DOMContentLoaded event fired.");

            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            const showLoginBtn = document.getElementById('showLoginBtn');
            const showSignupBtn = document.getElementById('showSignupBtn');
            const loginBtn = document.getElementById('loginBtn');
            const signupBtn = document.getElementById('signupBtn');
            const googleSignInBtn = document.getElementById('googleSignInBtn');

            // Set initial language to Arabic and update text content
            document.body.dir = 'rtl';
            showLoginBtn.textContent = getTranslation('login');
            showSignupBtn.textContent = getTranslation('signup');
            document.getElementById('loginTitle').textContent = getTranslation('login');
            document.getElementById('signupTitle').textContent = getTranslation('signup');
            document.getElementById('loginEmail').placeholder = getTranslation('email');
            document.getElementById('loginPassword').placeholder = getTranslation('password');
            document.getElementById('signupUsername').placeholder = getTranslation('username');
            document.getElementById('signupEmail').placeholder = getTranslation('email');
            document.getElementById('signupPassword').placeholder = getTranslation('password');
            loginBtn.textContent = getTranslation('login');
            signupBtn.textContent = getTranslation('signup');
            googleSignInBtn.querySelector('span').textContent = getTranslation('googleSignIn');


            // Ensure only the login modal is visible
            document.getElementById('loginSignupModal').classList.remove('hidden');
            document.getElementById('lobbyPage').classList.add('hidden');
            document.getElementById('gamePage').classList.add('hidden');

            // Default to login form visible
            loginForm.classList.remove('hidden');
            signupForm.classList.add('hidden');
            showLoginBtn.classList.add('active');
            showSignupBtn.classList.remove('active');


            await setupFirebase();

            // Login/Signup form toggling
            if (showLoginBtn && showSignupBtn && loginForm && signupForm) {
                showLoginBtn.addEventListener('click', () => {
                    loginForm.classList.remove('hidden');
                    signupForm.classList.add('hidden');
                    showLoginBtn.classList.add('active');
                    showSignupBtn.classList.remove('active');
                    document.getElementById('loginSignupError').textContent = '';
                    document.getElementById('signupError').textContent = '';
                });
                showSignupBtn.addEventListener('click', () => {
                    signupForm.classList.remove('hidden');
                    loginForm.classList.add('hidden');
                    showSignupBtn.classList.add('active');
                    showLoginBtn.classList.remove('active');
                    document.getElementById('loginSignupError').textContent = '';
                    document.getElementById('signupError').textContent = '';
                });
            }

            // Login/Signup button listeners
            if (loginBtn) {
                loginBtn.addEventListener('click', handleLogin);
                document.getElementById('loginEmail').addEventListener('keypress', (event) => {
                    if (event.key === 'Enter') handleLogin();
                });
                document.getElementById('loginPassword').addEventListener('keypress', (event) => {
                    if (event.key === 'Enter') handleLogin();
                });
            }
            if (signupBtn) {
                signupBtn.addEventListener('click', handleSignUp);
                document.getElementById('signupUsername').addEventListener('keypress', (event) => {
                    if (event.key === 'Enter') handleSignUp();
                });
                document.getElementById('signupEmail').addEventListener('keypress', (event) => {
                    if (event.key === 'Enter') handleSignUp();
                });
                document.getElementById('signupPassword').addEventListener('keypress', (event) => {
                    if (event.key === 'Enter') handleSignUp();
                });
            }

            // Google Sign-In button listener
            if (googleSignInBtn) {
                googleSignInBtn.addEventListener('click', signInWithGoogle);
            }
        });
    </script>
</body>
</html>

